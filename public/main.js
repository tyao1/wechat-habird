!function(){function e(e){En.setText(In.replace("%s",e))}function n(){An=tn.add.text(24,24,Jn,{font:"16px "+Nn,fill:"#fff"}),En=tn.add.text(24,120,"",{font:"24px "+Nn,fill:"#f00"}),e(0)}function t(){ct.innerHTML=""}function o(e){clearTimeout(Gn);var n='<div class="noti"><img src="'+e.headimgurl+'" class="avatar"><span class="notiName">'+e.nickname+"</span><span>的语音膜！</span></div>";ct.innerHTML=n,Gn=setTimeout(t,3500)}function i(){return window.AudioContext=window.AudioContext||window.webkitAudioContext,window.AudioContext?new window.AudioContext:void console.log("not support web audio api")}function a(){st.decodeAudioData(ut[0],function(e){lt=st.createBufferSource(),lt.buffer=e,lt.connect(st.destination),lt.start(0)})}function d(e){ut=[];var n=e,t=new XMLHttpRequest;t.open("GET",n,!0),t.responseType="arraybuffer",t.onload=function(){ut.push(t.response)},t.addEventListener("load",a),t.send()}function r(){superagent.get("./randomVoice").end(function(e,n){function t(){ht&&st?d(i):(Hn.setAttribute("src",i),Hn.setAttribute("preload",""),Hn.play(),Hn.volume=100)}if(!e){var i=n.body.src;i&&(window.WeixinJSBridge?WeixinJSBridge.invoke("getNetworkType",{},t,!1):document.addEventListener("WeixinJSBridgeReady",function(){WeixinJSBridge.invoke("getNetworkType",{},t)},!1),o(n.body.user))}})}function c(e,n){tn.load.audio(e,[n+".ogg",n+".mp3"])}function s(){n(),tn.load.onFileComplete.add(e),tn.load.spritesheet("frog",_n+"images/frog.png",96,96),tn.load.spritesheet("clouds",_n+"images/clouds.png",128,64),tn.load.image("pipe",_n+"images/pipe.png"),tn.load.image("ground",_n+"images/ground.png"),c("flap",_n+"sounds/flap");var t;for(t=1;zn>=t;t++)c("score"+t,_n+"sounds/score"+t);for(t=1;Yn>=t;t++)c("hurt"+t,_n+"sounds/hurt"+t)}function l(){return Xn+30*((tt>20?20:20-tt)/20)}function u(e,n){var t=rn.create(tn.width,e+(n?-l():l())/2,"pipe");return t.body.allowGravity=!1,t.scale.setTo(2,n?-2:2),t.body.offset.y=n?2*-t.body.height:0,t.body.velocity.x=-Vn,t}function f(){sn.stop();var e=(tn.height-16-l()/2)/2+(Math.random()>.5?-1:1)*Math.random()*tn.height/6,n=u(e);u(e,!0);var t=cn.create(n.x+n.width,0);t.width=2,t.height=tn.world.height,t.body.allowGravity=!1,t.body.velocity.x=-Vn,sn.add(1/Qn),sn.start()}function h(){rn=tn.add.group(),cn=tn.add.group()}function p(){rn.removeAll(),cn.removeAll()}function g(){sn=new Phaser.Timer(tn),sn.onEvent.add(f),sn.add(2),sn.start()}function w(){sn.stop(),rn.forEachAlive(function(e){e.body.velocity.x=0}),cn.forEach(function(e){e.body.velocity.x=0})}function v(){dn=tn.add.graphics(0,0),dn.beginFill($n,1),dn.drawRect(0,0,tn.world.width,tn.world.height),dn.endFill()}function y(){ln=tn.add.sprite(0,0,"frog"),ln.anchor.setTo(.5,.5),ln.body.collideWorldBounds=!0,ln.body.gravity.y=On}function b(){ln.body.allowGravity=!1,ln.angle=0,ln.scale.setTo(1,1),ln.reset(tn.world.width/4,tn.world.height/2)}function m(){un=tn.add.tileSprite(0,tn.world.height-32,tn.world.width,32,"ground"),un.tileScale.setTo(2,2)}function x(){hn.stop();var e=Math.random()*tn.height/2,n=fn.create(tn.width,e,"clouds",Math.floor(4*Math.random())),t=2+2*Math.random();n.alpha=2/t,n.scale.setTo(t,t),n.body.allowGravity=!1,n.body.velocity.x=-Vn/t,n.anchor.y=0,hn.start(),hn.add(4*Math.random())}function k(){fn=tn.add.group(),hn=new Phaser.Timer(tn),hn.onEvent.add(x),hn.add(Math.random()),hn.start()}function S(e,n,t){for(var o=1;t>=o;o++)e.push(tn.add.audio(n+o))}function T(){S(Zn,"score",zn),S(jn,"hurt",Yn),on=tn.add.audio("flap")}function M(e,n){var t;return 1==n?(t=e[0],t.play()):n>1&&(t=e[Math.floor(Math.random()*n)],t.play()),t}function E(){an=M(Zn,zn)}function A(){an&&an.stop(),M(jn,Yn)}function C(){on.isPlaying||on.play()}function B(e){e.forEachAlive(function(e){e.x+e.width<tn.world.bounds.left&&e.kill()})}function P(){B(fn),hn.update()}function L(){B(rn),sn.update()}function G(){un.tilePosition.x-=tn.time.physicsElapsed*Vn/2}function W(){var e=qn+ln.body.velocity.y;ln.angle=90*e/qn-180,ln.angle<0&&(ln.angle=0),et&&(ln.scale.setTo(1,-1),ln.angle=-20)}function H(){ln.y=tn.world.height/2+8*Math.cos(tn.time.now/200)}function I(){return ln.body.bottom<tn.world.bounds.bottom?tn.physics.overlap(ln,rn)?void F():void tn.physics.overlap(ln,cn,K):void F()}function K(e,n){cn.remove(n),tt+=1,U(),E(),socket.emit("score")}function U(){pn.setText(Kn.replace("%s",tt))}function F(){et=!0,w(),R(),A(),r(),socket.emit("gameover",{plus:tt,minus:Pn})}function R(){dt+=Pn,Ln.setText(Dn.replace("%s",dt)),Ln.renderable=!0;var e=Math.floor(tt/Pn*100);if(e=Un.replace("%s",tt).replace("%s",Pn).replace("%s",e),gn.setText(e),gn.renderable=!0,wn.renderable=!0,vn.events.onInputDown.addOnce(Y),yn.renderable=!0,bn.events.onInputDown.addOnce(function(){window.location="/high",Wn.classList.remove("active"),ot=!1}),mn.renderable=!0,!wx)return alert("今天被微信分享得罪了一下");var n={title:"轮到你给长者续命了！能击败我吗？",desc:"穿上红色的衣服！我奉献了"+Pn+"秒生命，为长者续了"+tt+"秒！",link:"http://moha.taskbee.cn/",imgUrl:"http://moha.taskbee.cn/images/frog.png",success:function(){E()},cancel:function(){A()}};wx.onMenuShareTimeline({title:"穿上红色的衣服！我奉献了"+Pn+"秒生命，为长者续了"+tt+"秒！",link:"http://moha.taskbee.cn/",imgUrl:"http://moha.taskbee.cn/images/frog.png",success:function(){E()},cancel:function(){A()}}),wx.onMenuShareAppMessage(n),wx.onMenuShareQQ(n),wx.onMenuShareWeibo(n),wx.onMenuShareQZone(n)}function D(){gn.renderable=!1,wn.renderable=!1,yn.renderable=!1,mn.renderable=!1}function J(e){var n=tn.add.sprite(e.x,e.y);return n.anchor.setTo(e.anchor.x,e.anchor.y),n.width=e.width,n.height=e.height,n}function N(){kn&&(Tn=tn.add.text(0,tn.world.height-24,kn,{font:"14px "+Nn,fill:"#fff",stroke:"#430",strokeThickness:4,align:"center"}),Sn&&(Tn.x=tn.world.width-Tn.width-12,Mn=J(Tn),Mn.inputEnabled=!0,Mn.events.onInputDown.add(Sn)))}function O(){N(),pn=tn.add.text(12,12,"",{font:"48px "+Nn,fill:"#fff",stroke:"#430",strokeThickness:4,align:"center"}),Cn=tn.add.text(12,pn.y+pn.height,"",{font:"14px "+Nn,fill:"#f00",align:"center"}),Ln=tn.add.text(tn.world.width/2,12,"",{font:"14px "+Nn,fill:"#f00",align:"center"}),Ln.anchor.setTo(.5,0),wn=tn.add.text(tn.world.width/2,tn.world.height-tn.world.height/6,Fn,{font:"30px "+Nn,fill:"#fff",stroke:"#430",strokeThickness:4,align:"center"}),wn.anchor.setTo(.5,.5),vn=J(wn),vn.inputEnabled=!0,yn=tn.add.text(tn.world.width/2,tn.world.height-2*tn.world.height/6,"膜蛤榜",{font:"30px "+Nn,fill:"#fff",stroke:"#430",strokeThickness:4,align:"center"}),yn.anchor.setTo(.5,.5),bn=J(yn),bn.inputEnabled=!0,mn=tn.add.text(tn.world.width,32,"转发或分享，和朋友谈笑风生⬆️",{font:"16px "+Nn,fill:"#fcfefe",stroke:"#430",strokeThickness:4}),mn.anchor.setTo(1,1),xn=J(mn),xn.inputEnabled=!0,gn=tn.add.text(tn.world.width/2,tn.world.height/2,"",{font:"32px "+Nn,fill:"#fff",stroke:"#430",strokeThickness:4,align:"center"}),gn.anchor.setTo(.5,.5)}function V(){Ln.renderable=!1,ln.body.allowGravity=!0,g(),nt=!0,Bn=tn.time.now}function q(){ot||(nt||V(),et||(ln.body.velocity.y=-qn,C()))}function Q(e,n){return e&&n?e==n[0]||e==n[1]:void 0}function X(){}function _(e){Q(e.keyCode,it)?q():Sn&&Q(e.keyCode,at)&&Sn()}function z(){tn.input.onDown.add(q),tn.input.keyboard.addCallbacks(tn,X,_)}function Y(){Cn.setText(""),tt=0,et=!1,nt=!1,D(),b(),p(),U()}function Z(){tn.stage.scaleMode=Phaser.StageScaleMode.SHOW_ALL,tn.stage.scale.setScreenSize(!0),v(),h(),m(),O(),k(),y(),T(),z(),Y()}function j(){var e=Math.floor(tn.time.elapsedSecondsSince(Bn))+1;Pn!=e&&(Pn=e,Cn.setText(Rn.replace("%s",Pn)))}function $(){P(),nt?(W(),et||(j(),I()),L()):H(),et||G()}function en(){rt&&(tn.debug.renderSpriteBody(vn),tn.debug.renderSpriteBody(ln),rn.forEachAlive(function(e){tn.debug.renderSpriteBody(e)}),cn.forEach(function(e){tn.debug.renderSpriteBody(e)}))}function nn(e){var n=document.querySelector("#go");n.addEventListener("click",function(){ot=!1,Wn.classList.add("active"),Y()}),void 0!==e.debug&&(rt=e.debug),void 0!==e.gravity&&(On=e.gravity),void 0!==e.speed&&(Vn=e.speed),void 0!==e.flap&&(qn=e.flap),void 0!==e.spawnRate&&(Qn=e.spawnRate),void 0!==e.opening&&(Xn=e.opening),void 0!==e.flapKeyCode&&(it=e.flapKeyCode),void 0!==e.numScoreSounds&&(zn=e.numScoreSounds),void 0!==e.numHurtSounds&&(Yn=e.numHurtSounds),void 0!==e.baseUrl&&(_n=e.baseUrl),void 0!==e.feedback&&(kn=e.feedback),void 0!==e.feedbackFunc&&(Sn=e.feedbackFunc),void 0!==e.feedbackKeyCode&&(at=e.feedbackKeyCode),tn=new Phaser.Game(580,580*Math.max(window.innerHeight/window.innerWidth,1.2)||700,Phaser.CANVAS,e.parent,{preload:s,create:Z,update:$,render:en},!1,!1)}var tn,on,an,dn,rn,cn,sn,ln,un,fn,hn,pn,gn,wn,vn,yn,bn,mn,xn,kn,Sn,Tn,Mn,En,An,Cn,Bn,Pn,Ln,Gn,Wn=document.getElementById("score"),Hn=document.getElementById("voice"),In="Loading...\n\n历史的行程: %s %",Kn="+ %s s",Un="我为长者续命%s秒\n志己的生命减少%s秒\n而且这个效率efficiency: %s%",Fn="重新续",Rn="- %s s",Dn="本次累计被续 %s 秒",Jn="[微小的提示]\n为了获得坠好的游戏体验，请：\n打开音量\n穿上红色的衣服",Nn='"Segoe UI", "Microsoft YaHei", 宋体, sans-serif',On=42,Vn=420,qn=620,Qn=.9,Xn=210,_n="",zn=10,Yn=9,Zn=[],jn=[],$n=14544639,et=!1,nt=!1,tt=0,ot=!1,it=[Phaser.Keyboard.E,Phaser.Keyboard.SPACEBAR],at=[Phaser.Keyboard.FIVE,Phaser.Keyboard.NUMPAD_5],dt=0,rt=!1,ct=document.getElementById("notisVoice"),st=i(),lt=null,ut=[],ft=navigator.userAgent,ht=!ft.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/);initGame=nn,document.addEventListener("WeixinJSBridgeReady",function(){r()},!1),initGame({feedback:"无可奉告",feedbackFunc:function(){window.location="https://taskbee.cn/feedback"},parent:document.querySelector("#screen")})}();
